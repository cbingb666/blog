(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{386:function(t,s,a){t.exports=a.p+"assets/img/image_6.fb92eb12.svg"},387:function(t,s,a){t.exports=a.p+"assets/img/image_9.aeafa84f.png"},388:function(t,s,a){t.exports=a.p+"assets/img/image_8.7780592b.png"},389:function(t,s,a){t.exports=a.p+"assets/img/image_7.ea713ef2.png"},390:function(t,s,a){t.exports=a.p+"assets/img/image_0.432ff064.png"},391:function(t,s,a){t.exports=a.p+"assets/img/image.18105a78.png"},392:function(t,s,a){t.exports=a.p+"assets/img/image_1.d8582664.png"},393:function(t,s,a){t.exports=a.p+"assets/img/image_2.d4f123cd.png"},394:function(t,s,a){t.exports=a.p+"assets/img/image_6.d7013f41.png"},395:function(t,s,a){t.exports=a.p+"assets/img/image_3.226cdb2b.png"},396:function(t,s,a){t.exports=a.p+"assets/img/image_4.b513e129.png"},397:function(t,s,a){t.exports=a.p+"assets/img/image_5.f28518d7.png"},432:function(t,s,a){"use strict";a.r(s);var e=a(54),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"自动化部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#自动化部署"}},[t._v("#")]),t._v(" 自动化部署")]),t._v(" "),e("h2",{attrs:{id:"采用技术"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#采用技术"}},[t._v("#")]),t._v(" 采用技术")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://www.docker.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Docker"),e("OutboundLink")],1),t._v(" 容器化技术")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.portainer.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Portainer"),e("OutboundLink")],1),t._v(" Docker可视化 (非必需)")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.jenkins.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jenkins"),e("OutboundLink")],1),t._v(" 自动化构建工具")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.nginx.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Nginx"),e("OutboundLink")],1),t._v(" 反向代理")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://docs.github.com/en/developers/webhooks-and-events/about-webhooks#:~:text=Webhooks%20allow%20you%20to%20build,to%20the%20webhook's%20configured%20URL.",target:"_blank",rel:"noopener noreferrer"}},[t._v("Github Webhooks"),e("OutboundLink")],1),t._v("\nGithub 网络钩子")])]),t._v(" "),e("h2",{attrs:{id:"自动化部署架构图"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#自动化部署架构图"}},[t._v("#")]),t._v(" 自动化部署架构图")]),t._v(" "),e("p",[e("img",{attrs:{src:a(386),alt:"自动化部署架构图"}})]),t._v(" "),e("h2",{attrs:{id:"开始"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#开始"}},[t._v("#")]),t._v(" 开始")]),t._v(" "),e("h3",{attrs:{id:"安装与初始配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装与初始配置"}},[t._v("#")]),t._v(" 安装与初始配置")]),t._v(" "),e("h4",{attrs:{id:"安装-docker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-docker"}},[t._v("#")]),t._v(" 安装 Docker")]),t._v(" "),e("p",[t._v("详见"),e("RouterLink",{attrs:{to:"/notes/docker.html"}},[t._v("Docker")])],1),t._v(" "),e("h4",{attrs:{id:"安装-jenkins"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-jenkins"}},[t._v("#")]),t._v(" 安装 Jenkins")]),t._v(" "),e("p",[t._v("详见"),e("RouterLink",{attrs:{to:"/notes/jenkins.html"}},[t._v("Jenkins")])],1),t._v(" "),e("h4",{attrs:{id:"在-jenkins-中添加全局github-ssh"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在-jenkins-中添加全局github-ssh"}},[t._v("#")]),t._v(" 在 Jenkins 中添加全局github ssh")]),t._v(" "),e("ol",[e("li",[t._v("进入 Jenkins 容器")])]),t._v(" "),e("div",{staticClass:"language-shell script extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("docker container "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" -it jenkins "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("bash")]),t._v("\n")])])]),e("ol",{attrs:{start:"2"}},[e("li",[t._v("生成ssh, 一直回车确认即可")])]),t._v(" "),e("div",{staticClass:"language-shell scriptimage.png extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("ssh-keygen -t rsa\n")])])]),e("ol",{attrs:{start:"3"}},[e("li",[t._v("查看ssh")])]),t._v(" "),e("div",{staticClass:"language-shell script extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看私钥")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" ~/.ssh/id_rsa\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看公钥")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" ~/.ssh/id_rsa.pub\n")])])]),e("ol",{attrs:{start:"4"}},[e("li",[e("p",[t._v("添加公钥到 github")])]),t._v(" "),e("li",[e("p",[t._v("添加私钥到 Jenkins Manage Credentials")]),t._v(" "),e("p",[t._v("进入ManageJenkins")]),t._v(" "),e("p",[e("img",{attrs:{src:a(387),alt:"进入ManageJenkins"}})]),t._v(" "),e("p",[t._v("进入Manage Credentials")]),t._v(" "),e("p",[e("img",{attrs:{src:a(388),alt:"进入Manage Credentials"}})]),t._v(" "),e("p",[t._v("添加一条凭证")]),t._v(" "),e("p",[e("img",{attrs:{src:a(389),alt:"添加一条凭证"}})])])]),t._v(" "),e("h3",{attrs:{id:"项目配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#项目配置"}},[t._v("#")]),t._v(" 项目配置")]),t._v(" "),e("h4",{attrs:{id:"为项目添加dockerfile"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#为项目添加dockerfile"}},[t._v("#")]),t._v(" 为项目添加Dockerfile")]),t._v(" "),e("blockquote",[e("p",[t._v("Dockerfile 配置如下")])]),t._v(" "),e("div",{staticClass:"language-dockerfile extra-class"},[e("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用nginx")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" nginx")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 复制 dist 目录 到 /usr/share/nginx/html/ 目录下")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" dist/ /usr/share/nginx/html/")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 复制 nginx/default.conf 到 /etc/nginx/conf.d/default.conf")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" nginx/default.conf /etc/nginx/conf.d/default.conf")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 暴露在80端口")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXPOSE")]),t._v(" 80")]),t._v("\n")])])]),e("h4",{attrs:{id:"为项目添加-nginx-default-conf"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#为项目添加-nginx-default-conf"}},[t._v("#")]),t._v(" 为项目添加 nginx/default.conf")]),t._v(" "),e("div",{staticClass:"language-conf extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("server {\n    listen       80;\n    server_name  localhost;\n\n    #charset koi8-r;\n    access_log  /var/log/nginx/host.access.log  main;\n    error_log  /var/log/nginx/error.log  error;\n\n    location / {\n        root   /usr/share/nginx/html;\n        index  index.html index.htm;\n    }\n\n    #error_page  404              /404.html;\n\n    # redirect server error pages to the static page /50x.html\n    #\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   /usr/share/nginx/html;\n    }\n}\n")])])]),e("h4",{attrs:{id:"在-jenkins-新建构建流"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在-jenkins-新建构建流"}},[t._v("#")]),t._v(" 在 Jenkins 新建构建流")]),t._v(" "),e("p",[t._v("创建新项目")]),t._v(" "),e("p",[e("img",{attrs:{src:a(390),alt:"image_0"}})]),t._v(" "),e("p",[t._v("填入github项目地址\n"),e("img",{attrs:{src:a(391),alt:"image"}})]),t._v(" "),e("p",[t._v("添加git源代码管理\n"),e("img",{attrs:{src:a(392),alt:"image_1"}})]),t._v(" "),e("p",[t._v("添加构建触发器\n"),e("img",{attrs:{src:a(393),alt:"image_2"}})]),t._v(" "),e("p",[t._v("在github仓库中进入settings设置webhook\n"),e("img",{attrs:{src:a(394),alt:"image_6"}})]),t._v(" "),e("p",[t._v("添加node构建环境\n"),e("img",{attrs:{src:a(395),alt:"image_3"}})]),t._v(" "),e("p",[t._v("添加Execute shell构建步\n"),e("img",{attrs:{src:a(396),alt:"image_4"}})]),t._v(" "),e("p",[t._v("在Execute shell加入一下脚本\n"),e("img",{attrs:{src:a(397),alt:"image_5"}})]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/bin/bash")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("IMAGE_NAME")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"notes"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CONTAINER_NAME")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"notes"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CONTAINER_ID")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" --registry"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http://registry.npm.taobao.org\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run build\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 打包镜像")]),t._v("\ndocker image build ./ -t "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$IMAGE_NAME")]),t._v(":latest\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 检查是否存在旧容器")]),t._v("\ndocker container inspect "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$CONTAINER_NAME")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$?")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 删除旧容器")]),t._v("\n    docker container "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -f "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$CONTAINER_NAME")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fi")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 运行容器")]),t._v("\ndocker run -p "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8845")]),t._v(":80 -d --name "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$CONTAINER_NAME")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$IMAGE_NAME")]),t._v(":latest\n")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);